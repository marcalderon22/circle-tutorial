version: 2.1
orbs:
  probely: probely/security-scan@1.1.3

jobs:
  my_probely_scan:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Install jq
          command: |
            sudo apt-get update && sudo apt-get install -y jq
      - probely/scan:
            target_id: $PROBELY_TARGET_ID
      - run:
          name: Wait for scan results
          command: sleep 300 # wait for 5 minutes
      - run:
          name: Get scans
          command: |
            curl -X GET "https://api.eu.probely.com/targets/39orRp99KgFc/scans/" \
            -H "Authorization: JWT $PROBELY_API_KEY" \
            -o scans.json
      - run:
          name: Extract last scan ID
          command: |
            ID_VALUE=$(jq -r 'results[0].id' scans.json)
            echo "ID Value: $ID_VALUE"
      - run:
          name: Download Probely scan results
          command: |
            curl -X GET "https://api.eu.probely.com/targets/$PROBELY_TARGET_ID/scans/$ID_VALUE/report/?report_type=default" \
            -H "Authorization: JWT $PROBELY_API_KEY" \
            -o probely-report.pdf

      
      - store_artifacts:
          path: probely-report.pdf
          destination: scan-results

          
workflows:
  version: 2
  example-workflow:
    jobs:
      - my_probely_scan:
          context: dast

        

          
